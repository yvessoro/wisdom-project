name: ðŸš€ Deploy to Salesforce

on:
  pull_request:
    branches:
      - master
      - preprod

jobs:
  test:
    name: âœ… VÃ©rification des Tests Apex
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout du Code
        uses: actions/checkout@v3

      - name: ðŸš€ Installer Salesforce CLI
        run: npm install --global sfdx-cli

      - name: ðŸ”‘ Authentification Salesforce
        run: |
          if [[ "${{ github.base_ref }}" == "master" ]]; then
            echo "${{ secrets.SALESFORCE_AUTH_URL_PROD }}" > ./authfile.txt
            sfdx auth:sfdxurl:store --sfdxurlfile=./authfile.txt -a prod-org
            echo "SF_ALIAS=prod-org" >> $GITHUB_ENV
          elif [[ "${{ github.base_ref }}" == "preprod" ]]; then
            echo "${{ secrets.SALESFORCE_AUTH_URL_PREPROD }}" > ./authfile.txt
            sfdx auth:sfdxurl:store --sfdxurlfile=./authfile.txt -a preprod-org
            echo "SF_ALIAS=preprod-org" >> $GITHUB_ENV
          fi

      - name: ðŸ› ï¸ ExÃ©cuter les Tests Apex
        run: sfdx force:apex:test:run -u $SF_ALIAS --wait 10 --resultformat human --codecoverage --outputdir test-results

  merge_and_deploy:
    name: ðŸš€ Merge Automatique et DÃ©ploiement
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: ðŸ“¥ Checkout du Code
        uses: actions/checkout@v3

      - name: ðŸš€ Installer Salesforce CLI
        run: npm install --global sfdx-cli

      - name: ðŸ”‘ Authentification Salesforce
        run: |
          if [[ "${{ github.base_ref }}" == "master" ]]; then
            echo "${{ secrets.SALESFORCE_AUTH_URL_PROD }}" > ./authfile.txt
            sfdx auth:sfdxurl:store --sfdxurlfile=./authfile.txt -a prod-org
            echo "SF_ALIAS=prod-org" >> $GITHUB_ENV
          elif [[ "${{ github.base_ref }}" == "preprod" ]]; then
            echo "${{ secrets.SALESFORCE_AUTH_URL_PREPROD }}" > ./authfile.txt
            sfdx auth:sfdxurl:store --sfdxurlfile=./authfile.txt -a preprod-org
            echo "SF_ALIAS=preprod-org" >> $GITHUB_ENV
          fi

      - name: ðŸš€ Merge automatique de la PR
        uses: devops-infra/action-pull-request@v0.5.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          merge_method: squash

      - name: ðŸš€ DÃ©ploiement vers l'environnement cible
        run: |
          echo "DÃ©ploiement vers $SF_ALIAS"
          sfdx force:source:deploy -u $SF_ALIAS -p force-app --testlevel RunLocalTests
